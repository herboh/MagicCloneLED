# LED Controller Audit - 2026-02-05

## Scope
- Backend: `backend/main.py`, `backend/bulb_manager.py`, `backend/led_controller.py`, `backend/color_utils.py`
- Frontend: `src/components/*`, `src/App.tsx`, `src/globals.css`
- Config/runtime: `README.md`, `package.json`

## Goal Alignment
Primary product goals inferred from repo docs:
- Reliable LAN bulb control with predictable API behavior.
- Real-time frontend control with low-latency updates.
- Keep architecture simple and maintainable.

## Verification Notes
- `python -m py_compile backend/*.py`: passed.
- `bun run build`: failed (`vite: command not found`) in this worktree environment.
- `bun run lint`: failed (`eslint: command not found`) in this worktree environment.

## Findings (Ordered by Severity)

### P0 - API returns wrong status codes for client errors
- Files: `backend/main.py:255`, `backend/main.py:294`, `backend/main.py:306`, `backend/main.py:359`, `backend/main.py:383`, `backend/main.py:392`
- Problem: route handlers catch broad `Exception` and rethrow `HTTPException(500, ...)`. This rewrites intentional `400/404/503` responses into `500`.
- Impact: frontend and API clients cannot distinguish bad input from server faults; retries and monitoring become inaccurate.
- Minimal fix: re-raise `HTTPException` unchanged before generic exception handling.

### P1 - Group command endpoint accepts invalid actions as success
- File: `backend/main.py:298`
- Problem: `/groups/command` has no explicit invalid-action branch; unknown actions can return `200` with empty `results`.
- Impact: silent no-op behavior, confusing UI, hard-to-debug automations.
- Minimal fix: add final `else` that raises `HTTPException(400, ...)`.

### P1 - React state mutation during render
- File: `src/components/controls/BulbControls.tsx:438`
- Problem: `.sort()` is called directly on `selectedTargets` and `groups[groupName]` inside render. `.sort()` mutates arrays in place.
- Impact: hidden state mutation can cause unstable selection behavior and hard-to-reproduce UI bugs.
- Minimal fix: compare copied arrays (`[...arr].sort()`) or use set-based comparison helper.

### P2 - WebSocket reconnect timer can survive unmount
- File: `src/components/controls/BulbControls.tsx:156`
- Problem: `setTimeout(connectWebSocket, 2000)` is not tracked/cleared on cleanup.
- Impact: potential reconnect attempts after component unmount and stray socket churn.
- Minimal fix: store timeout id in ref and clear in effect cleanup.

### P2 - Duplicated HSV conversion logic increases drift risk
- Files: `src/components/controls/BulbControls.tsx:42`, `src/components/color/ColorWheel.tsx:46`, `src/components/color/ColorWheel.tsx:112`
- Problem: frontend has multiple independent HSV/RGB/HEX conversion implementations.
- Impact: behavior drift and maintenance overhead.
- Minimal fix: centralize conversions in one utility module and reuse.

## Ranked Change List
1. Preserve HTTP status semantics in backend handlers (`P0`).
2. Validate group action inputs explicitly (`P1`).
3. Remove render-time array mutation in group selection (`P1`).
4. Cleanup WebSocket reconnect timer lifecycle (`P2`).
5. Consolidate frontend color conversion utilities (`P2`).

## Keep / Do Not Change
- `BulbManager` structure is appropriately simple for this app size.
- LED TCP controller abstraction is small and readable.
- Polling backoff strategy is pragmatic and low complexity.

